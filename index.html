<html>
    <head>
         <meta charset="UTF-8">
        <title></title>
        <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    
        <style>
            body {
                width: 100%;
                height: 100%;
                margin: 0;
            }

            .wrapper {
                border: 5px solid black;
                position: relative;
                width: 1000px;
                height: 1000px;
            }


            .wrapper canvas !important {
                position: absolute;
                top: 0;
                left: 0;
            }

            #nav_contents {
                margin-left: 20px;
            }

            .floating-menu {
                font-family: sans-serif;
                background: black;
                padding: 5px;
                width: 200px;
                z-index: 100;
                position: fixed;
                top: 0px;
                right: 0px;
                opacity: .8;
                margin: 2%;
            }

            .floating-menu a, .floating-menu h3 {
                font-size: 0.9em;
                display: block;
                margin: 0 0.5em;
                color: white;
            }

        </style>
    </head>
    <body>

        <nav class="floating-menu">
            <h3>Settings</h3>
            <div id="nav_contents">
                <div>
                    <input type="checkbox" id="centered" name="centered">
                    <label for="centered" style="color:white;">Centered</label>
                </div> 
                <div>
                    <input type="checkbox" id="static-enabled" name="static" checked>
                    <label for="static" style="color:white;">Static Background</label>
                </div>
                <div>
                	<input type="checkbox" id="stratify-enabled" name="stratify">
                    <label for="stratify" style="color:white;">Stratify</label>
                </div>

                <div>
                    <input type="checkbox" id="high-enabled" name="high">
                    <label for="high" style="color:white;">Highlight</label>
                </div>    
                <div style="width:200px;">
                    <label for="size" style="color:white;">Size&emsp;&emsp;&emsp;&emsp;&emsp;</label>
                    <select id="size-selector">
                        <option value=1>1 Pixels</option>
                        <option value=5>5 Pixels</option>
                        <option value=10>10 Pixels</option>
                        <option value=50>50 Pixels</option>
                        <option value=100>100 Pixels</option>
                        <option value=500>500 Pixels</option>
                        <option value=1000>1k Pixels</option>
                        <option value=5000>5k Pixels</option>
                        <option value=10000>10k Pixels</option>
                        <option value=50000>50k Pixels</option>
                        <option value=100000>100k Pixels</option>
                        <option value=500000>500k Pixels</option>
                    </select>
                </div>
                <div>
                    <label for="button" style="color:white;">Relocate&emsp;&emsp;&emsp;</label>
                    <button type="button" id="move">|~~~~~~~|</button>
                </div>
                <div style="width:200px;">
                    <label for="range" style="color:white;">First Stage Samples</label>
                    <select id="sample_selector">
                        <option value=0>0 Sample</option>
                        <option value=1>1 Sample</option>
                        <option value=2>2 Samples</option>
                        <option value=5>5 Samples</option>
                        <option value=10>10 Samples</option>
                        <option value=20>20 Samples</option>
                        <option value=50>50 Samples</option>
                        <option value=100>100 Samples</option>
                        <option value=200>200 Samples</option>
                        <option value=500>500 Samples</option>
                        <option value=1000>1000 Samples</option>
                    </select>
                </div>
                <div style="width:200px;">
                    <label for="range" style="color:white;">Second Stage Samples</label>
                    <select id="nsample_selector">
                        <option value=0>0 Sample</option>
                        <option value=1>1 Sample</option>
                        <option value=2>2 Samples</option>
                        <option value=5>5 Samples</option>
                        <option value=10>10 Samples</option>
                        <option value=20>20 Samples</option>
                        <option value=50>50 Samples</option>
                        <option value=100>100 Samples</option>
                        <option value=200>200 Samples</option>
                        <option value=500>500 Samples</option>
                        <option value=1000>1000 Samples</option>
                    </select>
                </div>

                <div>
                    <label for="button" style="color:white;"> First Stage Resample</label>
                    <button type="button" id="resample">|~~~~~~~|</button>
                </div> 
                <div>
                    <label for="button" style="color:white;">Second Stage Resample</label>
                    <button type="button" id="resample2">|~~~~~~~|</button>
                </div>
                <div> 
                    <label for = "button" style="color:white;">Auto-Detect &emsp;&emsp;</label>
                    <button type= "button" id = "auto_detect">|~~~~~~~|</button>
                </div>
        </nav>
        <div class="wrapper">
            <canvas id="dyn_canvas"></canvas>
            <canvas id="stat_canvas"></canvas>
            <canvas id= "first_strat_canvas"></canvas>
            <canvas id= "second_strat_canvas"></canvas>
            <h1 id="counter" style="display: none; font-size: 50px;
            width: 10%; margin-left: 3%; font-family: monospace;">0</h1>
        </div>

        <script>


            var canvas = document.getElementById('dyn_canvas');
            canvas.setAttribute('width', 1000);
            canvas.setAttribute('height', 1000);
            canvas.style.top = 0;
            canvas.style.left = 0;
            canvas.style.position = 'absolute';
            canvas.style.zIndex = 1;

            var static_canvas = document.getElementById('stat_canvas');
            static_canvas.setAttribute('width', 1000);
            static_canvas.setAttribute('height', 1000);
            static_canvas.style.top = 0;
            static_canvas.style.left = 0;
            static_canvas.style.position = 'absolute';
            static_canvas.style.zIndex = 0;

            var first_stratify_canvas = document.getElementById("first_strat_canvas");
            first_stratify_canvas.setAttribute('width', 1000);
            first_stratify_canvas.setAttribute('height', 1000);
           	first_stratify_canvas.style.top = 0;
            first_stratify_canvas.style.left = 0;
            first_stratify_canvas.style.position = 'absolute';
            first_stratify_canvas.style.zIndex = 2;

            var second_stratify_canvas = document.getElementById("second_strat_canvas");
            second_stratify_canvas.setAttribute('width', 1000);
            second_stratify_canvas.setAttribute('height', 1000);
           	second_stratify_canvas.style.top = 0;
            second_stratify_canvas.style.left = 0;
            second_stratify_canvas.style.position = 'absolute';
            second_stratify_canvas.style.zIndex = 3;



            var static_density = 200000;
            var normal_color = 'rgb(120,120,120)';

            var static_checkbox = document.getElementById("static-enabled");
            var stratify_checkbox = document.getElementById("stratify-enabled");
            var size_selector = document.getElementById("size-selector");
            var centered_checkbox = document.getElementById("centered");
            var high_checkbox = document.getElementById("high-enabled");
            var sample_selector = document.getElementById("sample_selector");
            var resample_button = document.getElementById("resample");
            var move_button = document.getElementById("move");
            var resample2_button = document.getElementById("resample2");
            var auto_button = document.getElementById("auto_detect");
            var counter = document.getElementById("counter");

            var static_enabled = static_checkbox.checked;
            var stratify_enabled = stratify_checkbox.checked;
            var blob_size = size_selector.value;
            var sample_size = sample_selector.value;

            var nsample_size = nsample_selector.value;
            var high_enabled = high_checkbox.checked;
            var centered = centered_checkbox.checked;

            static_checkbox.onchange = function() {
                static_enabled = static_checkbox.checked;
                if (static_enabled) {
                    static_canvas.style.display = 'block';
                } else {
                    static_canvas.style.display = 'none';
                }
            }

            stratify_checkbox.onchange = function(){
            	stratify_enabled = stratify_checkbox.checked;
            	if (stratify_enabled) {
            		first_stratify_canvas.style.display = 'block';
                    second_stratify_canvas.style.display = 'block';
                    first_stratify();
                    second_stratify();
                } else {
                    first_stratify_canvas.style.display = 'none';
                    second_stratify_canvas.style.display = 'none';
                    random_samples();
                    random2_samples();
                }
                soft_init();
            }

            size_selector.onchange = function() {
                blob_size = size_selector.value;
                contaminant.resize(calculate_radius(blob_size));
            }

            sample_selector.onchange = function() {
                sample_size = sample_selector.value;
                if (stratify_enabled){
                    first_stratify();
                } else {
                    random_samples();
                }
                soft_init();
            }

            nsample_selector.onchange = function(){
                nsample_size = nsample_selector.value;
                if (stratify_enabled){
                    second_stratify();
                } else {
                    random2_samples();
                }
                soft_init();
            }

            high_checkbox.onchange = function() {
                high_enabled = high_checkbox.checked;
                if (high_enabled) {
                    contaminant.recolor('red');
                } else {
                    contaminant.recolor(normal_color);
                }
            }

            centered_checkbox.onchange = function() {
                centered = centered_checkbox.checked;
                if (centered) {
                    contaminant.move_to(canvas.height/2, canvas.width/2);
                } else {
                    var bounds = find_random_bounds(blob_size);
                    contaminant.move_to(bounds[0], bounds[1]);   
                }
            }

            
            auto_button.onclick = function(){
                if (sample_size == 0 && nsample_size == 0) {
                    alert("Error: No Samples exist!");
                    return;
                }

                counter.style.display = "block";
                auto_detect(0);
            }

            resample2_button.onclick = function() {
                if (stratify_enabled) {
                    second_stratify();
                } else {
                    random2_samples();
                }
                soft_init();

            };
                
            resample_button.onclick = function() {
                if (stratify_enabled) {
                    first_stratify();
                } else {
                    random_samples();
                }
                soft_init();
            };

            move_button.onclick = function() {
                if (contaminant.x == (canvas.width/2) && contaminant.y == (canvas.height/2)) return;
                var b = find_random_bounds(calculate_area(contaminant.r));
                contaminant.move_to(b[0], b[1]);
            };

            function circle(x, y, r, color) {

                this.x = x;
                this.y = y;
                this.r = r;
                this.c = color;

                this.draw = function() {
                    var ctx = canvas.getContext('2d');

                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI, false);
                    ctx.fillStyle = this.c;
                    ctx.fill();
                }

                this.move_to = function(x, y) {
                    this.x = x;
                    this.y = y;
                    soft_init();
                    this.update();
                }

                this.delete = function() {
                    if (contaminant === this) {
                        contaminant = undefined;
                    } else {
                        first_stage = first_stage.filter(s => s.x != this.x && s.y != this.y);
                    }
                    soft_init();
                }

                this.resize = function(radius) {
                    this.r = radius;

                    if (this.y != (canvas.height/2) && this.x != (canvas.width/2)) {
                        var b = find_random_bounds(calculate_area(this.r));
                        this.x = b[0];
                        this.y = b[1];
                    }

                    soft_init();
                    this.update();
                }

                this.recolor = function(color) {
                    this.c = color;
                    soft_init();
                }

                this.is_caught = false;

                this.is_within = function (x, y) {
                    var d = Math.sqrt(Math.pow(this.x - x, 2) + Math.pow(this.y - y, 2));
                    if (d <= this.r)
                        return true;
                    return false;
                }

                this.update = function() {
                    if (contaminant === this) {

                        for (i = 0; i < first_stage.length; i++) {
                            var caught = this.is_within(first_stage[i].x,
                                first_stage[i].y);
                            if (caught) {
                                this.recolor('green');
                                this.is_caught = true;
                                return;
                            }
                        }

                        for (i = 0; i < second_stage.length; i++) {
                            var caught = this.is_within(second_stage[i].x,
                                second_stage[i].y);
                            if (caught) {
                                this.recolor('green');
                                this.is_caught = true;
                                return;
                            }
                        }

                        if (high_enabled) {
                            this.recolor('red');
                        } else {
                            this.recolor(normal_color);
                        }
                        this.is_caught = false;
                    }
                }

                return this;
            }

            let contaminant = undefined;

            let first_stage = [];
            let second_stage = [];

            function hard_init() {
                console.log(" Hard Initialization =======");


                if (static_enabled) static();
                var bounds;

                if (centered)
                    bounds = [Math.floor(canvas.width/2), Math.floor(canvas.height/2)];
                else
                    bounds = find_random_bounds(canvas.height, canvas.width, blob_size);

                contaminant = new circle(bounds[0], bounds[1], calculate_radius(blob_size), normal_color);
                contaminant.draw();

                if (stratify_enabled) {
                    first_stratify();
                    second_stratify();
                } else {
                    random_samples();
                    random2_samples();
                }
                
                soft_init();

                console.log(" Hard Initialization ======= Finished");
            }

            function soft_init() {
                console.log(" Soft Initialization =======");
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                contaminant.draw();

                for (i = 0; i < first_stage.length; i++) { 
                    first_stage[i].draw();
                }

                for (i = 0; i < second_stage.length; i++) { 
                    second_stage[i].draw();
                }
                console.log(" Soft Initialization ======= Finished");

            }

            function find_random_bounds(size) {

                var radius = calculate_radius(size);
                var x_centre = Math.floor(Math.random() * (canvas.width - (radius * 2))) + radius;
                var y_centre = Math.floor(Math.random() * (canvas.height - (radius * 2))) + radius;

                return [x_centre, y_centre];
            };

            function calculate_radius(area) {
                return Math.sqrt(area/Math.PI);
            }

            function calculate_area(radius) {
                return (Math.PI * (radius * radius));
            }

            function random_samples(){
                first_stage = [];

                for (var i = 0; i<sample_size; i++){
                    var pt = find_random_bounds(calculate_area(3));

                    var c = new circle(pt[0], pt[1], 3, 'orange');

                    first_stage.push(c);
                }

                contaminant.update();
            }

            function random2_samples(){
                second_stage = [];
                 for (var i = 0; i<nsample_size; i++){
                    var pt = find_random_bounds(calculate_area(3));

                    var c = new circle(pt[0], pt[1], 3, 'purple');

                    second_stage.push(c);
                }
                contaminant.update();
            }

            function static() {
                var ctx = static_canvas.getContext('2d');
                var cw = static_canvas.width;
                var ch = static_canvas.height;

                ctx.clearRect(0, 0, cw, ch);
                for (var i = 0; i < static_density; ++i) {
                    var ran = Math.random();
                    var x = Math.floor(Math.random() * cw);
                    var y = Math.floor(Math.random() * ch);
                    var r = Math.floor(ran * 256);
                    var g = Math.floor(ran * 256);
                    var b = Math.floor(ran * 256);
                 
                    ctx.fillStyle = 'rgb(' + r + ',' + g + ',' + b + ')';
                    ctx.fillRect(x, y, 1, 1);
                }

            }

            function first_stratify(){
            	var ctx = first_stratify_canvas.getContext('2d');
            	var cw = first_stratify_canvas.width;
                var ch = first_stratify_canvas.height;
                ctx.clearRect(0, 0, cw, ch);
                first_stage = [];
		    	var rect_width = cw / sample_size;

                var color1 = [0, 102, 0];
                var color2 = [0, 255, 0];

		    	for(var i=0; i<sample_size; i++){
		    		var x = (rect_width * i);
		    		var y = 0;

                    if (i % 2) {
                        r = color1[0];
                        g = color1[1];
                        b = color1[2];
                    } else {
                        r = color2[0];
                        g = color2[1];
                        b = color2[2];
                    }

			    	ctx.fillStyle = 'rgba(' + r + ',' + g + ',' + b + ',0.5)';
					ctx.fillRect(x, y, rect_width, ch);

                    if (!(i % 2)) {
                        r = color1[0];
                        g = color1[1];
                        b = color1[2];
                    } else {
                        r = color2[0];
                        g = color2[1];
                        b = color2[2];
                    }

                    x = x + (rect_width * Math.random());
                    y = ch * Math.random();

                    var c = new circle(x, y, 3, 'rgba(' + r + ',' + g + ',' + b + ')');
                    first_stage.push(c);
				}

                contaminant.update();
            }

            function second_stratify(){
                var ctx = second_stratify_canvas.getContext('2d');
                var cw = second_stratify_canvas.width;
                var ch = second_stratify_canvas.height;
                ctx.clearRect(0, 0, cw, ch);
                second_stage = [];
                var rect_height = ch / nsample_size;

                var color1 = [255, 140, 0];
                var color2 = [255, 215, 0];

                for(var i=0; i<nsample_size; i++){
                    var y = (rect_height * i);
                    var x = 0;

                    if (i % 2) {
                        r = color1[0];
                        g = color1[1];
                        b = color1[2];
                    } else {
                        r = color2[0];
                        g = color2[1];
                        b = color2[2];
                    }

                    ctx.fillStyle = 'rgba(' + r + ',' + g + ',' + b + ',0.5)';
                    ctx.fillRect(x, y, cw, rect_height);

                    if (!(i % 2)) {
                        r = color1[0];
                        g = color1[1];
                        b = color1[2];
                    } else {
                        r = color2[0];
                        g = color2[1];
                        b = color2[2];
                    }

                    y = y + (rect_height * Math.random());
                    x = cw * Math.random();

                    var c = new circle(x, y, 3, 'rgba(' + r + ',' + g + ',' + b + ')');
                    second_stage.push(c);

                }
                contaminant.update();
                
            }

            function speed() {
                var total_samples = first_stage.length + second_stage.length;
                var prop = total_samples * (blob_size/(canvas.width * canvas.height));
                var sp = 3000; // 3 seconds
                
                var delay = sp * prop;
                if (delay < 1)
                    return 0;
                return Math.ceil(delay);

            }

            function auto_detect(c) {
                
                if (contaminant.is_caught) {

                    if (c == 0) {
                        if (stratify_enabled) {
                            first_stratify();
                            second_stratify();
                        } else {
                            random_samples();
                            random2_samples();
                        }
                        soft_init();
                        auto_detect(c);
                        return;
                    }

                    return c;
                }

                if (stratify_enabled) {
                    first_stratify();
                    second_stratify();
                } else {
                    random_samples();
                    random2_samples();
                }


                soft_init();

                counter.innerHTML = c + 1; 

                return setTimeout(function() {
                    return auto_detect(c + 1);
                }, speed());  
            }

            hard_init();

        </script>
        </body>
</html>
